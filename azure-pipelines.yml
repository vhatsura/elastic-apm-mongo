trigger:
  branches:
    include:
    - master
    - refs/tags/*
  paths:
    exclude:
      - README.md

variables:
  buildConfiguration: 'Release'

stages:
- stage: Diagnostic
  displayName: Diagnostic Info
  condition: eq(variables['System.Debug'], 'true')
  jobs:
    - job:
      displayName: Print Azure Pipelines Diagnostic Info
      steps:
        - task: CmdLine@2
          displayName: Print current environment variables
          inputs:
            script: 'set'
    
- stage: CodeAnalysis
  displayName: Code Analysis
  dependsOn: [] # by specifying an empty array, this stage doesn't depend on the stage before it
  condition: not(startsWith(variables['Build.SourceBranch'], 'refs/tags/'))
  jobs:
    - job:
      displayName: Run Sonar Cloud
      pool:
        vmImage: ubuntu-latest
      steps:
        - task: UseDotNet@2
          displayName: Install .Net Core 2.2.x SDK
          inputs:
            packageType: sdk
            version: '2.2.x'

        - task: UseDotNet@2
          displayName: Install .Net Core 3.1.x SDK
          inputs:
            packageType: sdk
            version: '3.1.x'
                           
        - task: SonarCloudPrepare@1
          displayName: Prepare SonarCloud
          inputs:
           SonarCloud: 'SonarCloud vhatsura'
           organization: 'vhatsura'
           scannerMode: 'MSBuild'
           projectKey: 'elastic-apm-mongo'
           projectName: 'elastic-apm-mongo'
           extraProperties: |
             # Additional properties that will be passed to the scanner, 
             # Put one key=value per line, example:
             sonar.exclusions=examples/**/*
             sonar.test.exclusions=tests/**/*
             sonar.cs.opencover.reportsPaths=**/*.opencover.xml

        - task: DotNetCoreCLI@2
          displayName: Build
          inputs:
            command: build
            # disable parallel restore due to https://github.com/GitTools/GitVersion/issues/1381
            arguments: '--disable-parallel --configuration $(buildConfiguration)'

        - task: DotNetCoreCLI@2
          displayName: Test
          timeoutInMinutes: 5
          inputs:
            command: test
            # https://github.com/tonerdo/coverlet/blob/589e210e740bbf243cb0e57acbff7bf4e1ea8a66/Documentation/MSBuildIntegration.md#note-for-powershell--vsts-users
            arguments: '--no-build --configuration $(buildConfiguration) /p:CollectCoverage=true /p:CoverletOutputFormat=opencover /p:ExcludeByAttribute="Obsolete%2cGeneratedCodeAttribute%2cCompilerGeneratedAttribute"'

        - task: SonarCloudAnalyze@1
          displayName: Run Sonar Scanner
          
        - task: SonarCloudPublish@1
          displayName: Publish analyze artifacts to Sonar Cloud
          inputs:
            pollingTimeoutSec: '300'
          
            

#- stage: Artifacts
#  jobs:
#    - job:
#      displayName: Pack and Publish Artifacts
#      steps:
#        - task: DotNetCoreCLI@2
#          displayName: Pack
#          inputs:
#            command: pack
#            includesymbols: true
#            arguments: '--configuration $(buildConfiguration)'
#
#        - task: PublishBuildArtifacts@1
#          displayName: Publish build artifacts to Azure Pipelines
#          inputs:
#            artifactName: 'packages'
#
#        - script: |
#            COMMAND="$(git branch --contains tags/$BUILD_SOURCEBRANCHNAME)"
#            echo "##vso[task.setvariable variable=branch]${COMMAND}"
#          displayName: Identify Branch Name of tag  
#          condition: startsWith(variables['Build.SourceBranch'], 'refs/tags/') 
#
#        # DotNetCoreCLI@2 cannot push nuget packages to external NuGet feeds with authentication using an encrypted Api Key
#        # https://github.com/Microsoft/azure-pipelines-tasks/issues/7160    
#        - task: DotNetCoreCLI@2
#          displayName: Publish NuGet package to NuGet
#          # 'git branch --contains' command returns list of branches. In addition, two space characters are in name.
#          condition: and(in(variables['branch'], 'master', '  master'), startsWith(variables['Build.SourceBranch'], 'refs/tags/'))
#          inputs:
#            command: custom
#            custom: nuget
#            arguments: >
#              push $(Build.ArtifactStagingDirectory)/ElasticApm.MongoDB.$(Build.SourceBranchName).nupkg
#              -s https://api.nuget.org/v3/index.json
#              -k $(NuGetApiKey)